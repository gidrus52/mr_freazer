# Требования к памяти для сборки проекта

## О какой памяти идет речь?

Речь идет о **RAM (оперативной памяти)** вашего сервера, а не о дисковом пространстве.

## Проблема

При сборке frontend через Vite, Node.js использует память для:
- Компиляции TypeScript/JavaScript
- Обработки зависимостей
- Оптимизации и минификации кода
- Создания chunks и bundles

Если памяти не хватает, возникает ошибка:
```
FATAL ERROR: JavaScript heap out of memory
```

## Требования к памяти

### Минимальные требования:
- **2GB RAM** - для базовой сборки (может быть медленно)
- **4GB RAM** - рекомендуется для комфортной сборки
- **8GB RAM** - оптимально для быстрой сборки

### Текущая настройка:
В `nginx/Dockerfile` установлен лимит:
```dockerfile
ENV NODE_OPTIONS="--max-old-space-size=4096"
```
Это означает, что Node.js может использовать до **4GB RAM** для сборки.

## Как проверить доступную память на сервере

### Команда для проверки:

```bash
# Проверка памяти
free -h

# Или более детально
free -m
```

### Пример вывода:
```
              total        used        free      shared  buff/cache   available
Mem:           7.8G        1.2G        5.1G         45M        1.5G        6.2G
Swap:          2.0G          0B        2.0G
```

**Расшифровка:**
- `total` - общий объем RAM
- `used` - используется сейчас
- `free` - свободно
- `available` - доступно для использования (важно!)
- `Swap` - файл подкачки (виртуальная память)

## Что делать в зависимости от доступной памяти

### Если у вас 2GB RAM или меньше:

1. **Уменьшите лимит в Dockerfile:**
   ```dockerfile
   ENV NODE_OPTIONS="--max-old-space-size=1536"  # 1.5GB
   ```

2. **Добавьте swap (файл подкачки):**
   ```bash
   # Создайте swap 4GB
   sudo fallocate -l 4G /swapfile
   sudo chmod 600 /swapfile
   sudo mkswap /swapfile
   sudo swapon /swapfile
   
   # Сделайте постоянным
   echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
   ```

### Если у вас 4GB RAM:

Текущая настройка (4GB) должна работать, но может быть на пределе.

**Рекомендации:**
- Остановите другие процессы перед сборкой
- Добавьте swap 2-4GB для подстраховки

### Если у вас 8GB RAM или больше:

Можно увеличить лимит для более быстрой сборки:

```dockerfile
ENV NODE_OPTIONS="--max-old-space-size=6144"  # 6GB
```

## Как настроить лимит памяти

### 1. Проверьте доступную память:

```bash
free -h
```

### 2. Отредактируйте `nginx/Dockerfile`:

Найдите строку:
```dockerfile
ENV NODE_OPTIONS="--max-old-space-size=4096"
```

Измените значение в зависимости от доступной памяти:
- **1-2GB RAM:** `1536` или `2048`
- **4GB RAM:** `3072` или `4096` (текущее)
- **8GB+ RAM:** `6144` или `8192`

**Важно:** Не устанавливайте лимит больше, чем доступная память!

### 3. Пересоберите:

```bash
docker-compose build --no-cache nginx
```

## Добавление swap (рекомендуется)

Swap - это виртуальная память на диске. Помогает, когда RAM заканчивается.

### Создание swap файла:

```bash
# 1. Создайте файл (4GB)
sudo fallocate -l 4G /swapfile

# 2. Установите права
sudo chmod 600 /swapfile

# 3. Создайте swap
sudo mkswap /swapfile

# 4. Активируйте
sudo swapon /swapfile

# 5. Проверьте
free -h

# 6. Сделайте постоянным (после перезагрузки)
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
```

### Проверка swap:

```bash
# Проверьте, что swap активен
swapon --show

# Или
free -h
```

## Оптимизация сборки для экономии памяти

### 1. Упростите сборку в `vite.config.ts`:

```typescript
export default defineConfig({
  build: {
    // Отключите source maps для экономии памяти
    sourcemap: false,
    // Уменьшите chunk size
    chunkSizeWarningLimit: 1000,
  }
})
```

### 2. Удалите большие файлы перед сборкой:

В Dockerfile уже есть удаление `.rar`, `.zip` файлов.

### 3. Сборка по частям:

Если проект очень большой, можно собирать частично или использовать более легкие настройки.

## Проверка после настройки

```bash
# 1. Проверьте память
free -h

# 2. Пересоберите
docker-compose build --no-cache nginx

# 3. Следите за использованием памяти во время сборки
# В другом терминале:
watch -n 1 free -h
```

## Типичные значения

| RAM сервера | Рекомендуемый лимит | Swap |
|-------------|---------------------|------|
| 1GB         | 768MB               | 2GB  |
| 2GB         | 1536MB              | 2-4GB|
| 4GB         | 3072-4096MB         | 2-4GB|
| 8GB+        | 6144-8192MB         | Опционально |

## Проблемы и решения

### Проблема: "Cannot allocate memory"

**Решение:** Уменьшите лимит или добавьте swap

### Проблема: Сборка очень медленная

**Решение:** Увеличьте лимит (если есть память) или добавьте swap

### Проблема: Сервер зависает при сборке

**Решение:** 
1. Уменьшите лимит
2. Остановите другие процессы
3. Добавьте swap

## Быстрая проверка

```bash
# Проверьте память
free -h

# Если доступно меньше 2GB, уменьшите лимит до 1536
# Если доступно 4GB+, текущая настройка (4096) должна работать
# Если доступно 8GB+, можно увеличить до 6144
```

